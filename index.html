<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<title>Safe 离线签名器（EIP-712 / iPad 摄像头适配）</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<style>
  :root{--fg:#111827;--muted:#6b7280;--br:#e5e7eb;--mask:rgba(0,0,0,.45);--accent:#60a5fa}
  body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:24px;max-width:900px;color:var(--fg)}
  h1{font-size:22px;margin:0 0 12px}
  .card{border:1px solid var(--br);border-radius:12px;padding:16px;margin:16px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  label{display:block}
  input,textarea,button{font-size:14px}
  input[type=text],input[type=password],textarea{width:100%;padding:10px;border:1px solid var(--br);border-radius:10px;font-family:monospace}
  textarea{min-height:140px}
  button{padding:10px 14px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;cursor:pointer}
  button.ghost{background:#fff;color:#111}
  .muted{color:var(--muted)}
  .mono{font-family:monospace}

  /* === 摄像头容器：固定取景比例，视频覆盖裁剪 === */
  .cam{position:relative;width:100%;max-width:720px;aspect-ratio:3/4;background:#000;border-radius:12px;overflow:hidden;margin-top:10px}
  .cam video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  .cam canvas{display:none}
  /* 扫描框与遮罩 */
  .overlay{position:absolute;inset:0;pointer-events:none}
  .mask{position:absolute;inset:0;background:var(--mask);clip-path:polygon(
      0% 0%,100% 0%,100% 100%,0% 100%,
      0% 100%,0% 0%);}
  .guide{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
         width:min(70%,480px);aspect-ratio:1/1;border:2px solid var(--accent);border-radius:12px;
         box-shadow:0 0 0 9999px var(--mask)}
  .tip{position:absolute;left:50%;top:calc(50% + min(40%,275px));transform:translateX(-50%);color:#fff;background:rgba(0,0,0,.35);padding:4px 8px;border-radius:999px;font-size:12px}

  /* 小屏优化（iPhone 竖屏） */
  @media (max-width:420px){
    .guide{width:86%}
  }
</style>
</head>
<body>
<h1>Safe 离线签名器（EIP-712）</h1>

<div class="card">
  <h2>导入 EIP-712 JSON（来自在线端）</h2>
  <div class="row">
    <button id="btn_scan" class="ghost">摄像头扫码导入</button>
    <span class="muted">或粘贴到下方文本框</span>
  </div>
  <textarea id="typed_json" placeholder='{"domain":{"verifyingContract":"0x...","chainId":1},"types":{"SafeTx":[...]}, "message":{...}, "primaryType":"SafeTx"}'></textarea>

  <div id="cam_box" class="card" style="display:none">
    <div class="row"><button id="btn_stop" class="ghost">停止扫码</button><span id="scan_status" class="muted"></span></div>

    <div class="cam" id="cam">
      <!-- playsinline 防止 iOS 全屏；muted + autoplay 让 iOS 能自动播放 -->
      <video id="video" playsinline muted autoplay></video>
      <canvas id="canvas"></canvas>
      <div class="overlay">
        <div class="guide"></div>
        <div class="tip">对准二维码中央方框</div>
      </div>
    </div>
  </div>

  <div class="row"><button id="btn_parse">解析与校验</button><span id="parse_status" class="muted"></span></div>
  <pre id="summary" class="mono"></pre>
</div>

<div class="card">
  <h2>离线签名</h2>
  <label>私钥（仅本机内存）<input id="priv" type="password" placeholder="0x..."/></label>
  <div class="row"><button id="btn_sign">签名</button><span id="sign_status" class="muted"></span></div>
  <label>签名（hex）<input id="sig" type="text" readonly/></label>
  <div class="row"><div><div class="muted">签名二维码</div><div id="qr_sig" style="margin-top:6px"></div></div></div>
  <pre id="recovered" class="mono"></pre>
</div>

<script src="./libs/ethers.umd.min.js"></script>
<script src="./libs/qrcode.min.js"></script>
<script src="./libs/jsQR.js"></script>
<script>
(function(){
  const $=id=>document.getElementById(id);
  let typed=null, domain=null, types=null, message=null, hash=null;

  // ====== 摄像头扫码（iPad 适配）======
  let stream=null, rafId=null;
  const video=$("video"), canvas=$("canvas"), camBox=$("cam_box"), scanTip=$("scan_status");

  async function startCamera(){
    // iOS Safari 更喜欢 ideal 提示；同时保留 fallback
    const constraints = {
      video: {
        facingMode: { ideal: "environment" },
        width:  { ideal: 1920, max: 2560 },
        height: { ideal: 1080, max: 1440 }
      },
      audio: false
    };
    // 确保 playsinline 属性存在（防止 iOS 全屏）
    video.setAttribute("playsinline", "true");
    try{
      stream = await navigator.mediaDevices.getUserMedia(constraints);
    }catch(e){
      // 回退：不指定分辨率
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio:false });
    }
    video.srcObject = stream;
    await video.play();
  }

  function stopScan(){
    if(rafId) cancelAnimationFrame(rafId), rafId=null;
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    video.srcObject=null;
    camBox.style.display="none";
  }

  function tick(){
    if(!video.videoWidth){ rafId=requestAnimationFrame(tick); return; }

    // 始终使用传感器原始分辨率，避免 CSS 缩放导致的细条问题
    const vw = video.videoWidth, vh = video.videoHeight;
    canvas.width = vw; canvas.height = vh;
    const ctx = canvas.getContext("2d", { willReadFrequently: true });

    // 只截取中央正方形，提高扫码成功率（和 UI 框一致）
    const side = Math.min(vw, vh) * 0.75; // 取 75% 的方形区域
    const sx = (vw - side) / 2;
    const sy = (vh - side) / 2;

    ctx.drawImage(video, sx, sy, side, side, 0, 0, side, side);
    const img = ctx.getImageData(0, 0, side, side);
    const code = jsQR(img.data, side, side, { inversionAttempts: "attemptBoth" });

    if(code && code.data){
      try{
        JSON.parse(code.data);
        $("typed_json").value = code.data;
        scanTip.textContent = "已识别并填入 JSON";
        stopScan();
        return;
      }catch(err){
        // 不是 JSON 就忽略，继续扫描
      }
    }
    rafId = requestAnimationFrame(tick);
  }

  $("btn_scan").onclick = async ()=>{
    camBox.style.display="";
    scanTip.textContent = "启动摄像头…";
    try{
      await startCamera();
      scanTip.textContent = "请对准二维码中央方框";
      tick();
    }catch(e){
      scanTip.textContent = "摄像头失败：" + e.message;
    }
  };
  $("btn_stop").onclick = stopScan;

  // 方向变化后，重新进入扫描更稳
  window.addEventListener("orientationchange", ()=>{
    if(stream){ stopScan(); }
  });
  window.addEventListener("resize", ()=>{
    // 不用处理 video 尺寸，CSS 自动适配；canvas 每帧按原始分辨率重设
  });

  // ====== 解析/签名逻辑（保持不变）======
  $("btn_parse").onclick=()=>{
    try{
      typed=JSON.parse($("typed_json").value||"{}");
      domain=typed.domain; types=typed.types; message=typed.message;
      if(!domain||!types||!message) throw new Error("缺少 domain/types/message");
      if(!typed.primaryType) typed.primaryType="SafeTx";
      hash = ethers.TypedDataEncoder.hash(domain, types, message);
      $("parse_status").textContent="解析成功";
      $("summary").textContent =
        "verifyingContract: "+domain.verifyingContract+"\n"+
        "chainId: "+domain.chainId+"\n"+
        "primaryType: "+typed.primaryType+"\n"+
        "safeTxHash: "+hash+"\n\n"+
        "message:\n"+JSON.stringify(message,null,2);
    }catch(e){ $("parse_status").textContent="错误："+e.message; $("summary").textContent=""; }
  };

  $("btn_sign").onclick=async ()=>{
    try{
      if(!typed||!hash) throw new Error("请先解析 EIP-712 JSON");
      const priv=($("priv").value||"").trim();
      if(!/^0x[0-9a-fA-F]{64}$/.test(priv)) throw new Error("私钥格式不正确");
      const w=new ethers.Wallet(priv);
      const sig=await w.signTypedData(domain, types, message);
      $("sig").value=sig;
      $("sign_status").textContent="已签名";
      const div=$("qr_sig"); div.innerHTML="";
      new QRCode(div,{text:sig,width:240,height:240,colorDark:"#000",colorLight:"#fff",correctLevel:QRCode.CorrectLevel.M});
      const recovered=ethers.verifyTypedData(domain, types, message, sig);
      $("recovered").textContent = "Signer: "+w.address+"\nRecovered: "+recovered+"\nMatch: "+(ethers.getAddress(recovered)===ethers.getAddress(w.address));
    }catch(e){ $("sign_status").textContent="错误："+e.message; $("sig").value=""; $("qr_sig").innerHTML=""; $("recovered").textContent=""; }
  };
})();
</script>
</body>
</html>

<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<title>Safe 离线签名器（EIP-712 / 扫码私钥）</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  :root{--fg:#111827;--muted:#6b7280;--br:#e5e7eb}
  body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:24px;max-width:900px;color:var(--fg)}
  h1{font-size:22px;margin:0 0 12px}
  .card{border:1px solid var(--br);border-radius:12px;padding:16px;margin:16px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  label{display:block}
  input,textarea,button{font-size:14px}
  input[type=text],input[type=password],textarea{width:100%;padding:10px;border:1px solid var(--br);border-radius:10px;font-family:monospace}
  textarea{min-height:140px}
  button{padding:10px 14px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;cursor:pointer}
  button.ghost{background:#fff;color:#111}
  .muted{color:var(--muted)}
  .mono{font-family:monospace}
  video{width:100%;max-height:260px;background:#000;border-radius:10px}
  canvas{display:none}
  .warn{background:#fff7ed;border:1px solid #fdba74;color:#9a3412;border-radius:10px;padding:10px;margin-top:8px}
</style>
</head>
<body>
<h1>Safe 离线签名器（EIP-712）</h1>

<!-- 导入 EIP-712 JSON -->
<div class="card">
  <h2>导入 EIP-712 JSON（来自在线端）</h2>
  <div class="row">
    <button id="btn_scan" class="ghost">摄像头扫码导入</button>
    <span class="muted">或粘贴到下方文本框</span>
  </div>
  <textarea id="typed_json" placeholder='{"domain":{"verifyingContract":"0x...","chainId":1},"types":{"SafeTx":[...]}, "message":{...}, "primaryType":"SafeTx"}'></textarea>
  <div id="cam_box" class="card" style="display:none">
    <div class="row"><button id="btn_stop" class="ghost">停止扫码</button><span id="scan_status" class="muted"></span></div>
    <video id="video" playsinline muted></video><canvas id="canvas"></canvas>
  </div>
  <div class="row"><button id="btn_parse">解析与校验</button><span id="parse_status" class="muted"></span></div>
  <pre id="summary" class="mono"></pre>
</div>

<!-- 离线签名（新增：扫码私钥） -->
<div class="card">
  <h2>离线签名</h2>
  <div class="warn">
    ⚠️ 强安全提示：仅在<strong>完全离线</strong>且<strong>受控</strong>的设备上使用“扫码私钥”。确保浏览器不会保存录像/截图/缓存；签名完成后建议关机或清除会话。
  </div>
  <div class="row">
    <label style="flex:1">私钥（仅本机内存）
      <input id="priv" type="password" placeholder="0x..." />
    </label>
    <button id="btn_scan_priv" class="ghost">扫码私钥</button>
    <button id="btn_clear_priv" class="ghost">清空私钥</button>
    <span id="priv_status" class="muted"></span>
  </div>
  <div id="cam_priv_box" class="card" style="display:none">
    <div class="row"><button id="btn_stop_priv" class="ghost">停止扫码</button><span id="scan_priv_status" class="muted"></span></div>
    <video id="video_priv" playsinline muted></video><canvas id="canvas_priv"></canvas>
  </div>

  <div class="row"><button id="btn_sign">签名</button><span id="sign_status" class="muted"></span></div>
  <label>签名（hex）<input id="sig" type="text" readonly/></label>
  <div class="row"><div><div class="muted">签名二维码</div><div id="qr_sig" style="margin-top:6px"></div></div></div>
  <pre id="recovered" class="mono"></pre>
</div>

<script src="./libs/ethers.umd.min.js"></script>
<script src="./libs/qrcode.min.js"></script>
<script src="./libs/jsQR.js"></script>
<script>
(function(){
  const $=id=>document.getElementById(id);

  let typed=null, domain=null, types=null, message=null, hash=null;

  // ========== 扫码导入 EIP-712 JSON ==========
  let stream=null, rafId=null;
  $("btn_scan").onclick=async ()=>{
    $("cam_box").style.display="";
    $("scan_status").textContent="启动摄像头…";
    try{
      stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
      $("video").srcObject=stream; await $("video").play();
      $("scan_status").textContent="请对准 EIP-712 JSON 二维码";
      tickJSON();
    }catch(e){ $("scan_status").textContent="摄像头失败："+e.message; }
  };
  $("btn_stop").onclick=stopScanJSON;
  function stopScanJSON(){ if(rafId)cancelAnimationFrame(rafId); rafId=null; if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
    $("video").srcObject=null; $("cam_box").style.display="none"; }
  function tickJSON(){
    const v=$("video"); if(!v.videoWidth){ rafId=requestAnimationFrame(tickJSON); return; }
    const c=$("canvas"),ctx=c.getContext("2d"); c.width=v.videoWidth; c.height=v.videoHeight;
    ctx.drawImage(v,0,0,c.width,c.height);
    const img=ctx.getImageData(0,0,c.width,c.height);
    const code=jsQR(img.data,c.width,c.height,{inversionAttempts:"attemptBoth"});
    if(code && code.data){
      try{
        const txt=code.data.trim();
        JSON.parse(txt);
        $("typed_json").value=txt;
        $("scan_status").textContent="已填入 JSON";
        stopScanJSON();
      }catch(e){}
    }
    rafId=requestAnimationFrame(tickJSON);
  }

  // ========== 解析 EIP-712 ==========
  $("btn_parse").onclick=()=>{
    try{
      typed=JSON.parse($("typed_json").value||"{}");
      domain=typed.domain; types=typed.types; message=typed.message;
      if(!domain||!types||!message) throw new Error("缺少 domain/types/message");
      if(!typed.primaryType) typed.primaryType="SafeTx";
      hash = ethers.TypedDataEncoder.hash(domain, types, message);
      $("parse_status").textContent="解析成功";
      $("summary").textContent =
        "verifyingContract: "+domain.verifyingContract+"\n"+
        "chainId: "+domain.chainId+"\n"+
        "primaryType: "+typed.primaryType+"\n"+
        "safeTxHash: "+hash+"\n\n"+
        "message:\n"+JSON.stringify(message,null,2);
    }catch(e){ $("parse_status").textContent="错误："+e.message; $("summary").textContent=""; }
  };

  // ========== 扫码私钥（新增）==========
  let streamPriv=null, rafIdPriv=null;
  $("btn_scan_priv").onclick=async ()=>{
    $("cam_priv_box").style.display="";
    $("scan_priv_status").textContent="启动摄像头…";
    try{
      streamPriv=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
      $("video_priv").srcObject=streamPriv; await $("video_priv").play();
      $("scan_priv_status").textContent="请对准 私钥 二维码（支持 0x开头64hex 或 JSON: {privateKey/priv:\"0x...\"}）";
      tickPriv();
    }catch(e){ $("scan_priv_status").textContent="摄像头失败："+e.message; }
  };
  $("btn_stop_priv").onclick=stopScanPriv;
  function stopScanPriv(){ if(rafIdPriv)cancelAnimationFrame(rafIdPriv); rafIdPriv=null; if(streamPriv){streamPriv.getTracks().forEach(t=>t.stop());streamPriv=null;}
    $("video_priv").srcObject=null; $("cam_priv_box").style.display="none"; }

  function extractPriv(text){
    const s=text.trim();
    // 直接 0x + 64 hex
    if(/^0x[0-9a-fA-F]{64}$/.test(s)) return s;
    // 兼容 JSON 包裹
    try{
      const j=JSON.parse(s);
      if (j && typeof j==="object"){
        if (typeof j.privateKey==="string" && /^0x[0-9a-fA-F]{64}$/.test(j.privateKey)) return j.privateKey;
        if (typeof j.priv==="string" && /^0x[0-9a-fA-F]{64}$/.test(j.priv)) return j.priv;
      }
    }catch(_){}
    return null;
  }

  function tickPriv(){
    const v=$("video_priv"); if(!v.videoWidth){ rafIdPriv=requestAnimationFrame(tickPriv); return; }
    const c=$("canvas_priv"),ctx=c.getContext("2d"); c.width=v.videoWidth; c.height=v.videoHeight;
    ctx.drawImage(v,0,0,c.width,c.height);
    const img=ctx.getImageData(0,0,c.width,c.height);
    const code=jsQR(img.data,c.width,c.height,{inversionAttempts:"attemptBoth"});
    if(code && code.data){
      const maybe=extractPriv(code.data);
      if(maybe){
        $("priv").value = maybe;    // 仍为 password 类型，不在界面显示明文
        $("priv_status").textContent = "已通过二维码填入私钥";
        stopScanPriv();
        return;
      }
    }
    rafIdPriv=requestAnimationFrame(tickPriv);
  }

  $("btn_clear_priv").onclick=()=>{
    $("priv").value="";
    $("priv_status").textContent="已清空";
  };

  // ========== 签名 ==========
  $("btn_sign").onclick=async ()=>{
    try{
      if(!typed||!hash) throw new Error("请先解析 EIP-712 JSON");
      const priv=($("priv").value||"").trim();
      if(!/^0x[0-9a-fA-F]{64}$/.test(priv)) throw new Error("私钥格式不正确");
      const w=new ethers.Wallet(priv);
      const sig=await w.signTypedData(domain, types, message);
      $("sig").value=sig;
      $("sign_status").textContent="已签名";
      const div=$("qr_sig"); div.innerHTML=""; new QRCode(div,{text:sig,width:240,height:240,colorDark:"#000",colorLight:"#fff",correctLevel:QRCode.CorrectLevel.M});
      const recovered=ethers.verifyTypedData(domain, types, message, sig);
      $("recovered").textContent = "Signer: "+w.address+"\nRecovered: "+recovered+"\nMatch: "+(ethers.getAddress(recovered)===ethers.getAddress(w.address));
    }catch(e){
      $("sign_status").textContent="错误："+e.message;
      $("sig").value=""; $("qr_sig").innerHTML=""; $("recovered").textContent="";
    }
  };
})();
</script>
</body>
</html>

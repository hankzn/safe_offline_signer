<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<title>Safe 提交者 · 离线 EOA 签名器（tx_human / EIP-1559 分离模块）</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<style>
  :root{
    --fg:#111827; --muted:#6b7280; --br:#e5e7eb; --accent:#111;
    --scan-size: min(85vmin, 720px);
  }
  body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:24px;max-width:1000px;color:var(--fg)}
  h1{font-size:22px;margin:0 0 12px}
  .card{border:1px solid var(--br);border-radius:12px;padding:16px;margin:16px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  label{display:block}
  input,textarea,button{font-size:14px}
  input[type=text],input[type=number],input[type=password],textarea{width:100%;padding:10px;border:1px solid var(--br);border-radius:10px;font-family:monospace}
  textarea{min-height:120px}
  button{padding:10px 14px;border-radius:10px;border:1px solid var(--accent);background:var(--accent);color:#fff;cursor:pointer}
  button.ghost{background:#fff;color:var(--accent)}
  .muted{color:var(--muted)}
  .mono{font-family:monospace}
  .ok{color:#16a34a;font-weight:700}
  .bad{color:#dc2626;font-weight:700}

  .cam-wrap{position:relative;border:1px solid var(--br);border-radius:12px;overflow:hidden;background:#000;margin-top:10px}
  .cam-wrap .preview{position:relative;width:100%;height:80vh;max-height:92vh;min-height:320px}
  .cam-wrap video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  .cam-wrap canvas{display:none}
  .scan-overlay{pointer-events:none;position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
  .scan-overlay::before{
    content:""; display:block; width:var(--scan-size); aspect-ratio:1/1;
    border:2px solid rgba(255,255,255,.95); border-radius:16px;
    box-shadow:0 0 0 9999px rgba(0,0,0,.35);
  }
  .hint{position:absolute;bottom:10px;left:0;right:0;text-align:center;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.6);font-size:14px}

  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
</style>
</head>
<body>
<h1>Safe 提交者 · 离线 EOA 签名器</h1>

<!-- 模块 A：tx_human.json（支持多帧 SAFEQR） -->
<div class="card">
  <h2>模块 A：接收 tx_human.json（支持多帧 SAFEQR）</h2>
  <div class="row">
    <button id="btn_scan_human" class="ghost">摄像头扫码（SAFEQR / 单帧）</button>
    <button id="btn_reset_human" class="ghost">重置会话</button>
    <span id="human_rx_status" class="muted"></span>
  </div>

  <div id="cam_human" class="cam-wrap" style="display:none">
    <div class="preview">
      <video id="video_human" playsinline webkit-playsinline muted></video>
      <canvas id="canvas_human"></canvas>
      <div class="scan-overlay"></div>
      <div class="hint">将 SAFEQR 连续所有帧置于白框内</div>
    </div>
    <div class="row" style="padding:10px">
      <button id="btn_stop_human" class="ghost">停止扫码</button>
      <span id="scan_human_status" class="muted"></span>
    </div>
  </div>

  <div class="row" style="margin-top:8px">
    <label style="flex:1">或粘贴 tx_human.json（支持紧凑键名）<textarea id="txt_human" placeholder='{"kind":"ETH","to":"0x...","data_hex":"0x...","chainId":1,"nonce":...,"gas":...,"maxFeePerGas_gwei":...,"maxPriorityFeePerGas_gwei":...}'></textarea></label>
  </div>

  <div class="row">
    <button id="btn_parse_human">解析 tx_human.json</button>
    <button id="btn_fill_human" class="ghost">一键填充至下方表单</button>
    <span id="parse_human_status" class="muted"></span>
  </div>

  <pre id="human_view" class="mono"></pre>
</div>

<!-- 模块 B：EIP-1559 原生交易 JSON（单帧 QR 或粘贴） -->
<div class="card">
  <h2>模块 B：接收原生 EIP-1559 交易 JSON</h2>
  <div class="row">
    <button id="btn_scan_raw" class="ghost">摄像头扫码（单帧）</button>
    <button id="btn_reset_raw" class="ghost">清空</button>
    <span id="raw_rx_status" class="muted"></span>
  </div>

  <div id="cam_raw" class="cam-wrap" style="display:none">
    <div class="preview">
      <video id="video_raw" playsinline webkit-playsinline muted></video>
      <canvas id="canvas_raw"></canvas>
      <div class="scan-overlay"></div>
      <div class="hint">将 EIP-1559 JSON 二维码置于白框内</div>
    </div>
    <div class="row" style="padding:10px">
      <button id="btn_stop_raw" class="ghost">停止扫码</button>
      <span id="scan_raw_status" class="muted"></span>
    </div>
  </div>

  <div class="row" style="margin-top:8px">
    <label style="flex:1">或粘贴 EIP-1559 JSON<textarea id="txt_raw" placeholder='{"type":2,"chainId":"0x1","nonce":"0x12","to":"0x...","value":"0x0","gas":"0x5208","maxFeePerGas":"0x...","maxPriorityFeePerGas":"0x...","data":"0x..."}'></textarea></label>
  </div>

  <div class="row">
    <button id="btn_parse_raw">解析 EIP-1559 JSON</button>
    <button id="btn_fill_raw" class="ghost">一键填充至下方表单</button>
    <span id="parse_raw_status" class="muted"></span>
  </div>

  <pre id="raw_view" class="mono"></pre>
</div>

<!-- 统一的 EIP-1559 填写/确认与签名 -->
<div class="card">
  <h2>确认 EIP-1559 字段（离线签名）</h2>
  <div class="grid2">
    <label>chainId<input id="chainId" type="number" placeholder="1"/></label>
    <label>nonce<input id="nonce" type="number" placeholder="从在线端查询"/></label>
    <label>to<input id="to" type="text" placeholder="0x..."/></label>
    <label>value (wei)<input id="valueWei" type="text" placeholder="0"/></label>
    <label>gasLimit<input id="gas" type="number" placeholder="估算/在线端提供"/></label>
    <label>maxFeePerGas (gwei)<input id="maxFee" type="text" placeholder=""/></label>
    <label>maxPriorityFeePerGas (gwei)<input id="maxPrio" type="text" placeholder=""/></label>
    <label>data (hex)<input id="dataHex" type="text" placeholder="0x"/></label>
  </div>
</div>

<div class="card">
  <h2>私钥 & 签名</h2>
  <div class="row">
    <label style="flex:1">私钥<input id="priv" type="password" placeholder="0x..." autocomplete="off" autocapitalize="off" spellcheck="false"/></label>
    <button id="btn_scan_priv" class="ghost">扫码私钥</button>
    <button id="btn_clear_priv" class="ghost">清空私钥</button>
    <span id="priv_status" class="muted"></span>
  </div>

  <div id="cam_priv" class="cam-wrap" style="display:none">
    <div class="preview">
      <video id="video_priv" playsinline webkit-playsinline muted></video>
      <canvas id="canvas_priv"></canvas>
      <div class="scan-overlay"></div>
      <div class="hint">将“私钥”二维码置于白框内</div>
    </div>
    <div class="row" style="padding:10px">
      <button id="btn_stop_priv" class="ghost">停止扫码</button>
      <span id="scan_priv_status" class="muted"></span>
    </div>
  </div>

  <div class="row" style="margin-top:8px">
    <button id="btn_sign">签名交易（EIP-1559）</button>
    <span id="sign_status" class="muted"></span>
  </div>

  <div class="grid2">
    <label>RawTx<input id="rawtx" type="text" readonly/></label>
    <label>Tx Hash<input id="txhash" type="text" readonly/></label>
  </div>
  <div class="row"><div><div class="muted">RawTx 二维码</div><div id="qr_raw" style="margin-top:6px"></div></div></div>
</div>

<script src="./libs/ethers.umd.min.js"></script>
<script src="./libs/qrcode.min.js"></script>
<script src="./libs/jsQR.js"></script>
<script>
(function(){
  const $=id=>document.getElementById(id);

  /* ========== 摄像头通用（iPad 适配：大预览、中心方裁剪） ========== */
  async function openCamera(videoEl){
    const constraints={ audio:false, video:{ facingMode:{ideal:"environment"}, width:{ideal:1920}, height:{ideal:1080}, aspectRatio:{ideal:16/9} } };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    videoEl.srcObject = stream; await videoEl.play(); return stream;
  }
  function prepSquareFrame(videoEl, canvasEl){
    const vw=videoEl.videoWidth||1280, vh=videoEl.videoHeight||720;
    const s=Math.min(vw,vh), sx=(vw-s)/2, sy=(vh-s)/2;
    const size=800; canvasEl.width=size; canvasEl.height=size; return { sx,sy,s,dx:0,dy:0,w:size,h:size };
  }
  function startScanner({boxId,videoId,canvasId,statusId,onDecoded}){
    const box=$(boxId), video=$(videoId), canvas=$(canvasId), status=$(statusId);
    let stream=null, raf=null, running=false;
    async function begin(){ box.style.display=""; status.textContent="启动摄像头…";
      try{ stream=await openCamera(video); status.textContent="请将二维码置于白框内"; running=true; tick();
        window.addEventListener("resize", onResize); window.addEventListener("orientationchange", onResize);
      }catch(e){ status.textContent="摄像头失败："+e.message; } }
    function stop(){ running=false; if(raf) cancelAnimationFrame(raf), raf=null;
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
      video.srcObject=null; box.style.display="none";
      window.removeEventListener("resize", onResize); window.removeEventListener("orientationchange", onResize); }
    function onResize(){}
    function tick(){ if(!running) return;
      if(!video.videoWidth){ raf=requestAnimationFrame(tick); return; }
      const ctx=canvas.getContext("2d"); const {sx,sy,s,dx,dy,w,h}=prepSquareFrame(video,canvas);
      ctx.drawImage(video, sx,sy,s,s, dx,dy,w,h);
      const img=ctx.getImageData(0,0,w,h); const code=jsQR(img.data,w,h,{inversionAttempts:"attemptBoth"});
      if(code && code.data){ const ok = onDecoded(code.data); if(ok){ stop(); return; } }
      raf=requestAnimationFrame(tick);
    }
    return { begin, stop };
  }

  /* ========== 工具 ========== */
  const K2S = {k:"kind",f:"from",t:"to",vw:"value_wei",ae:"amount_eth",d:"data_hex",c:"chainId",n:"nonce",g:"gas",mf:"maxFeePerGas_gwei",mp:"maxPriorityFeePerGas_gwei"};
  function expandCompact(obj){ const out={}; for(const k in obj){ out[K2S[k]||k]=obj[k]; } return out; }
  function toBigIntLoose(v){
    if(typeof v==="bigint") return v;
    if(typeof v==="number") return BigInt(Math.trunc(v));
    if(typeof v==="string"){
      const s=v.trim();
      if(/^0x[0-9a-fA-F]+$/.test(s)) return BigInt(s);
      if(/^\d+(\.\d+)?$/.test(s)){ if(s.includes(".")) throw new Error("不支持小数，请换最小单位"); return BigInt(s); }
    }
    throw new Error("无法解析数值："+v);
  }
  function toNumberLoose(v){
    if(typeof v==="number") return v;
    if(typeof v==="string" && /^\d+(\.\d+)?$/.test(v)) return Number(v);
    if(typeof v==="string" && /^0x[0-9a-fA-F]+$/.test(v)) return parseInt(v,16);
    if(typeof v==="bigint") return Number(v);
    throw new Error("无法解析为数字："+v);
  }
  function gweiFromWeiLike(v){
    if(typeof v==="string" && !/^0x/i.test(v) && v.includes(".")) return v; // 已是 gwei 文本
    const wei = toBigIntLoose(v);
    const gweiStr = ethers.formatUnits(wei, "gwei");
    const [i,f=""]=gweiStr.split(".");
    return f ? (i+"."+f.slice(0,6).replace(/0+$/,"")).replace(/\.$/,"") : i;
  }
  async function sha256Hex(str){
    const bytes=new TextEncoder().encode(str);
    const hash=await crypto.subtle.digest("SHA-256", bytes);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  /* ========== 模块 A：tx_human（SAFEQR 多帧） ========== */
  let humanSession=null; // { id, n, sum, parts:[], received:Set, text? }
  function resetHuman(){ humanSession=null; $("human_rx_status").textContent="已重置"; $("human_view").textContent=""; $("txt_human").value=""; }
  $("btn_reset_human").onclick = resetHuman;

  function tryFeedHumanFrame(text){
    // 1) SAFEQR
    try{
      const o=JSON.parse(text);
      if(o && o.t==="SAFEQR" && o.v===1 && typeof o.id==="string" && typeof o.i==="number" && typeof o.n==="number" && typeof o.data==="string"){
        if(!humanSession || humanSession.id!==o.id){
          humanSession={ id:o.id, n:o.n, sum:o.sum||"", parts:new Array(o.n), received:new Set() };
        }
        if(o.n!==humanSession.n) return false;
        humanSession.parts[o.i]=o.data; humanSession.received.add(o.i);
        $("human_rx_status").textContent=`会话 ${humanSession.id}：已收帧 ${humanSession.received.size}/${humanSession.n}`;
        if(humanSession.received.size===humanSession.n){ humanSession.text=humanSession.parts.join(""); return true; }
        return false;
      }
    }catch(_){}
    // 2) 单帧 JSON
    try{
      JSON.parse(text);
      humanSession={ id:"single", n:1, sum:"", parts:[text], received:new Set([0]), text };
      $("human_rx_status").textContent=`单帧 JSON 已接收（长度 ${text.length}）`;
      return true;
    }catch(_){}
    return false;
  }

  const humanScanner = startScanner({
    boxId:"cam_human", videoId:"video_human", canvasId:"canvas_human", statusId:"scan_human_status",
    onDecoded:(payload)=> tryFeedHumanFrame((payload||"").trim())
  });
  $("btn_scan_human").onclick = ()=> humanScanner.begin();
  $("btn_stop_human").onclick = ()=> humanScanner.stop();

  function normalizeFromTxHumanText(text){
    const raw=JSON.parse(text);
    const obj=expandCompact(raw);
    if(!obj.to) throw new Error("tx_human 缺少 to");
    if(!obj.chainId) throw new Error("tx_human 缺少 chainId");
    const chainId = toNumberLoose(obj.chainId);
    const to = String(obj.to).trim();
    const data = (obj.data_hex||"0x").trim();
    const nonce = (obj.nonce!=null) ? toNumberLoose(obj.nonce) : "";
    const gas = (obj.gas!=null) ? toNumberLoose(obj.gas) : "";
    let valueWei="0";
    if(obj.value_wei!=null) valueWei = String(toBigIntLoose(obj.value_wei));
    else if(obj.amount_eth!=null) valueWei = ethers.parseUnits(String(obj.amount_eth), "ether").toString();
    const maxFeeGwei   = (obj.maxFeePerGas_gwei!=null) ? String(obj.maxFeePerGas_gwei) : "";
    const maxPrioGwei  = (obj.maxPriorityFeePerGas_gwei!=null) ? String(obj.maxPriorityFeePerGas_gwei) : "";
    return { chainId, to, data, nonce, gas, valueWei, maxFeeGwei, maxPrioGwei, pretty:obj };
  }

  $("btn_parse_human").onclick = async ()=>{
    try{
      let txt = $("txt_human").value.trim();
      if(!txt){ if(!humanSession || !humanSession.text) throw new Error("请先扫码或粘贴 tx_human.json"); txt = humanSession.text; }
      if(humanSession && humanSession.sum){
        const fullHash=await sha256Hex(txt); const short=fullHash.slice(0,16);
        if(short.toLowerCase()!==humanSession.sum.toLowerCase()) throw new Error(`整体哈希不匹配：expected ${humanSession.sum} got ${short}`);
      }
      const norm = normalizeFromTxHumanText(txt);
      $("human_view").textContent = JSON.stringify({schema:"tx_human", normalized:norm, original:norm.pretty}, null, 2);
      $("parse_human_status").textContent="解析成功（tx_human）";
      // 暂存（用于一键填充）
      window.__last_human_norm = norm;
    }catch(e){ $("parse_human_status").textContent="错误："+e.message; $("human_view").textContent=""; }
  };

  $("btn_fill_human").onclick = ()=>{
    const n=window.__last_human_norm;
    if(!n){ $("parse_human_status").textContent="请先解析 tx_human.json"; return; }
    $("chainId").value = n.chainId ?? "";
    $("to").value      = n.to ?? "";
    $("dataHex").value = n.data ?? "0x";
    $("nonce").value   = n.nonce ?? "";
    $("gas").value     = n.gas ?? "";
    $("valueWei").value= n.valueWei ?? "0";
    if(n.maxFeeGwei!=="")  $("maxFee").value = n.maxFeeGwei;
    if(n.maxPrioGwei!=="") $("maxPrio").value= n.maxPrioGwei;
  };

  /* ========== 模块 B：原生 EIP-1559（单帧） ========== */
  function resetRaw(){ $("raw_rx_status").textContent="已清空"; $("raw_view").textContent=""; $("txt_raw").value=""; }
  $("btn_reset_raw").onclick = resetRaw;

  const rawScanner = startScanner({
    boxId:"cam_raw", videoId:"video_raw", canvasId:"canvas_raw", statusId:"scan_raw_status",
    onDecoded:(payload)=>{ try{ JSON.parse((payload||"").trim()); $("txt_raw").value=(payload||"").trim(); $("raw_rx_status").textContent="已填入 JSON"; return true; }catch(_){ return false; } }
  });
  $("btn_scan_raw").onclick = ()=> rawScanner.begin();
  $("btn_stop_raw").onclick = ()=> rawScanner.stop();

  function isLikelyRaw1559(o){
    if(o==null || typeof o!=="object") return false;
    if(o.type===2 || o.type==="0x2") return true;
    if(o.maxFeePerGas!=null || o.maxPriorityFeePerGas!=null) return true;
    if(o.gas!=null || o.gasLimit!=null) return true;
    return false;
  }
  function normalizeFromRaw1559(o){
    if(!isLikelyRaw1559(o)) throw new Error("看起来不是 EIP-1559 交易 JSON");
    const chainId = toNumberLoose(o.chainId);
    const nonce   = toNumberLoose(o.nonce);
    const to      = String(o.to||"").trim();
    const data    = (o.data||"0x").trim();
    const gas     = (o.gas!=null)? toNumberLoose(o.gas) : (o.gasLimit!=null? toNumberLoose(o.gasLimit) : "");
    const valueWei= String(toBigIntLoose(o.value||0));
    const maxFeeGwei  = (o.maxFeePerGas!=null) ? gweiFromWeiLike(o.maxFeePerGas) : "";
    const maxPrioGwei = (o.maxPriorityFeePerGas!=null) ? gweiFromWeiLike(o.maxPriorityFeePerGas) : "";
    return { chainId, to, data, nonce, gas, valueWei, maxFeeGwei, maxPrioGwei, pretty:o };
  }

  $("btn_parse_raw").onclick = ()=>{
    try{
      const txt=$("txt_raw").value.trim(); if(!txt) throw new Error("请粘贴或扫码原生 EIP-1559 JSON");
      const obj=JSON.parse(txt); const norm=normalizeFromRaw1559(obj);
      $("raw_view").textContent = JSON.stringify({schema:"raw_1559", normalized:norm, original:norm.pretty}, null, 2);
      $("parse_raw_status").textContent="解析成功（EIP-1559 原生）";
      window.__last_raw_norm = norm;
    }catch(e){ $("parse_raw_status").textContent="错误："+e.message; $("raw_view").textContent=""; }
  };

  $("btn_fill_raw").onclick = ()=>{
    const n=window.__last_raw_norm;
    if(!n){ $("parse_raw_status").textContent="请先解析 EIP-1559 JSON"; return; }
    $("chainId").value = n.chainId ?? "";
    $("to").value      = n.to ?? "";
    $("dataHex").value = n.data ?? "0x";
    $("nonce").value   = n.nonce ?? "";
    $("gas").value     = n.gas ?? "";
    $("valueWei").value= n.valueWei ?? "0";
    if(n.maxFeeGwei!=="")  $("maxFee").value = n.maxFeeGwei;
    if(n.maxPrioGwei!=="") $("maxPrio").value= n.maxPrioGwei;
  };

  /* ========== 私钥扫码/清空 ========== */
  function extractPriv(text){
    const s=text.trim();
    if(/^0x[0-9a-fA-F]{64}$/.test(s)) return s;
    try{
      const j=JSON.parse(s);
      if(j && typeof j==="object"){
        if(typeof j.privateKey==="string" && /^0x[0-9a-fA-F]{64}$/.test(j.privateKey)) return j.privateKey;
        if(typeof j.priv==="string" && /^0x[0-9a-fA-F]{64}$/.test(j.priv)) return j.priv;
      }
    }catch(_){}
    return null;
  }
  const privScanner = startScanner({
    boxId:"cam_priv", videoId:"video_priv", canvasId:"canvas_priv", statusId:"scan_priv_status",
    onDecoded:(payload)=>{ const maybe=extractPriv((payload||"").trim()); if(maybe){ $("priv").value=maybe; $("priv_status").textContent="已通过二维码填入私钥"; return true; } return false; }
  });
  $("btn_scan_priv").onclick = ()=> privScanner.begin();
  $("btn_stop_priv").onclick = ()=> privScanner.stop();
  $("btn_clear_priv").onclick = ()=> { $("priv").value=""; $("priv_status").textContent="已清空"; };

  /* ========== 签名（EIP-1559） ========== */
  function toWeiGwei(x){ return ethers.parseUnits(String(x), "gwei"); }
  $("btn_sign").onclick = async ()=>{
    try{
      const priv=($("priv").value||"").trim();
      if(!/^0x[0-9a-fA-F]{64}$/.test(priv)) throw new Error("私钥格式不正确");
      const w=new ethers.Wallet(priv);

      const chainId=Number($("chainId").value||"");
      const nonce=Number($("nonce").value||"");
      const to=($("to").value||"").trim();
      const valueWei=BigInt(($("valueWei").value||"0").trim());
      const gasLimit=BigInt(($("gas").value||"").trim());
      const maxFeePerGas=toWeiGwei(($("maxFee").value||"").trim());
      const maxPriorityFeePerGas=toWeiGwei(($("maxPrio").value||"").trim());
      const data=($("dataHex").value||"0x").trim();

      if(!chainId) throw new Error("缺少 chainId");
      if(!Number.isFinite(nonce)) throw new Error("缺少或不合法的 nonce");
      if(!/^0x[0-9a-fA-F]{40}$/.test(to)) throw new Error("to 地址不合法");
      if(!data.startsWith("0x")) throw new Error("data 必须以 0x 开头");
      if(gasLimit<=0n) throw new Error("gasLimit 不能为空");
      if(maxFeePerGas<=0n || maxPriorityFeePerGas<0n) throw new Error("gas 价格不合法");
      if(maxFeePerGas<maxPriorityFeePerGas) throw new Error("maxFeePerGas 必须 ≥ maxPriorityFeePerGas");

      const tx={ type:2, chainId, nonce, to, value:valueWei, data, gasLimit, maxFeePerGas, maxPriorityFeePerGas };
      const raw=await w.signTransaction(tx);
      const txhash=ethers.keccak256(raw);
      $("rawtx").value=raw; $("txhash").value=txhash; $("sign_status").textContent="签名完成";

      const div=$("qr_raw"); div.innerHTML="";
      new QRCode(div,{text:raw,width:280,height:280,colorDark:"#000",colorLight:"#fff",correctLevel:QRCode.CorrectLevel.M});
    }catch(e){
      $("sign_status").textContent="错误："+e.message;
      $("rawtx").value=""; $("txhash").value=""; $("qr_raw").innerHTML="";
    }
  };
})();
</script>
</body>
</html>

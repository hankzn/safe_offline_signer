<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<title>Safe 提交者 · 离线 EOA 签名器（SAFEQR / EIP-1559 / iPad 适配）</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<style>
  :root{
    --fg:#111827; --muted:#6b7280; --br:#e5e7eb; --accent:#111;
    --scan-size: min(85vmin, 720px);
  }
  body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:24px;max-width:1000px;color:var(--fg)}
  h1{font-size:22px;margin:0 0 12px}
  .card{border:1px solid var(--br);border-radius:12px;padding:16px;margin:16px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  label{display:block}
  input,textarea,button{font-size:14px}
  input[type=text],input[type=number],input[type=password],textarea{width:100%;padding:10px;border:1px solid var(--br);border-radius:10px;font-family:monospace}
  textarea{min-height:120px}
  button{padding:10px 14px;border-radius:10px;border:1px solid var(--accent);background:var(--accent);color:#fff;cursor:pointer}
  button.ghost{background:#fff;color:var(--accent)}
  .muted{color:var(--muted)}
  .mono{font-family:monospace}

  .cam-wrap{position:relative;border:1px solid var(--br);border-radius:12px;overflow:hidden;background:#000;margin-top:10px}
  .cam-wrap .preview{position:relative;width:100%;height:80vh;max-height:92vh;min-height:320px}
  .cam-wrap video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  .cam-wrap canvas{display:none}
  .scan-overlay{pointer-events:none;position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
  .scan-overlay::before{
    content:""; display:block; width:var(--scan-size); aspect-ratio:1/1;
    border:2px solid rgba(255,255,255,.95); border-radius:16px;
    box-shadow:0 0 0 9999px rgba(0,0,0,.35);
  }
  .hint{position:absolute;bottom:10px;left:0;right:0;text-align:center;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.6);font-size:14px}

  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .ok{color:#16a34a;font-weight:700}
  .bad{color:#dc2626;font-weight:700}
</style>
</head>
<body>
<h1>Safe 提交者 · 离线 EOA 签名器</h1>

<!-- 1) 接收 tx_human.json 或 原生 EIP-1559 JSON -->
<div class="card">
  <h2>接收 tx_human.json / 原生 EIP-1559 JSON（支持多帧 SAFEQR）</h2>
  <div class="row">
    <button id="btn_scan_tx" class="ghost">摄像头扫码</button>
    <button id="btn_reset_session" class="ghost">重置会话</button>
    <span id="rx_status" class="muted"></span>
  </div>

  <div id="cam_tx" class="cam-wrap" style="display:none">
    <div class="preview">
      <video id="video_tx" playsinline webkit-playsinline muted></video>
      <canvas id="canvas_tx"></canvas>
      <div class="scan-overlay"></div>
      <div class="hint">请将二维码置于白色框内（连续扫描所有帧）</div>
    </div>
    <div class="row" style="padding:10px">
      <button id="btn_stop_tx" class="ghost">停止扫码</button>
      <span id="scan_tx_status" class="muted"></span>
    </div>
  </div>

  <div class="row" style="margin-top:8px">
    <label style="flex:1">或粘贴（自动识别 tx_human / 原生 EIP-1559）<textarea id="txt_txjson" placeholder='示例1：{"kind":"ETH","to":"0x...","data_hex":"0x...","chainId":1,...}
示例2（EIP-1559 原生）：{"type":2,"chainId":"0x1","nonce":"0x12","to":"0x...","value":"0x0","gas":"0x5208","maxFeePerGas":"0x...","maxPriorityFeePerGas":"0x...","data":"0x..."}'></textarea></label>
  </div>

  <div class="row">
    <button id="btn_parse_tx">解析 JSON</button>
    <span id="parse_tx_status" class="muted"></span>
  </div>

  <pre id="tx_human_view" class="mono"></pre>
</div>

<!-- 2) 填写/确认 EIP-1559 字段（完全离线） -->
<div class="card">
  <h2>确认 EIP-1559 字段（离线）</h2>
  <div class="grid2">
    <label>chainId<input id="chainId" type="number" placeholder="1"/></label>
    <label>nonce<input id="nonce" type="number" placeholder="从在线端查询"/></label>
    <label>to<input id="to" type="text" placeholder="0x..."/></label>
    <label>value (wei)<input id="valueWei" type="text" placeholder="0 或 数值（wei）"/></label>
  </div>
  <div class="grid2">
    <label>gasLimit<input id="gas" type="number" placeholder="估算/在线端提供"/></label>
    <label>maxFeePerGas (gwei)<input id="maxFee" type="text" placeholder="在线端给的档位或原生JSON换算"/></label>
    <label>maxPriorityFeePerGas (gwei)<input id="maxPrio" type="text" placeholder="在线端给的档位或原生JSON换算"/></label>
    <label>data (hex)<input id="dataHex" type="text" placeholder="0x..."/></label>
  </div>
  <div class="row">
    <button id="btn_lock" class="ghost">一键从 JSON 填充</button>
    <span id="lock_status" class="muted"></span>
  </div>
</div>

<!-- 3) 私钥输入/扫码 · 签名 -->
<div class="card">
  <h2>私钥 & 签名</h2>
  <div class="row">
    <label style="flex:1">私钥<input id="priv" type="password" placeholder="0x..." autocomplete="off" autocapitalize="off" spellcheck="false"/></label>
    <button id="btn_scan_priv" class="ghost">扫码私钥</button>
    <button id="btn_clear_priv" class="ghost">清空私钥</button>
    <span id="priv_status" class="muted"></span>
  </div>

  <div id="cam_priv" class="cam-wrap" style="display:none">
    <div class="preview">
      <video id="video_priv" playsinline webkit-playsinline muted></video>
      <canvas id="canvas_priv"></canvas>
      <div class="scan-overlay"></div>
      <div class="hint">请将“私钥”二维码置于白色框内</div>
    </div>
    <div class="row" style="padding:10px">
      <button id="btn_stop_priv" class="ghost">停止扫码</button>
      <span id="scan_priv_status" class="muted"></span>
    </div>
  </div>

  <div class="row" style="margin-top:8px">
    <button id="btn_sign">签名交易（EIP-1559）</button>
    <span id="sign_status" class="muted"></span>
  </div>

  <div class="grid2">
    <label>RawTx<input id="rawtx" type="text" readonly/></label>
    <label>Tx Hash<input id="txhash" type="text" readonly/></label>
  </div>
  <div class="row"><div><div class="muted">RawTx 二维码</div><div id="qr_raw" style="margin-top:6px"></div></div></div>
</div>

<script src="./libs/ethers.umd.min.js"></script>
<script src="./libs/qrcode.min.js"></script>
<script src="./libs/jsQR.js"></script>
<script>
(function(){
  const $=id=>document.getElementById(id);

  // ========= 摄像头通用（iPad 适配：大预览、中心方裁剪） =========
  async function openCamera(videoEl){
    const constraints={
      audio:false,
      video:{ facingMode:{ideal:"environment"}, width:{ideal:1920}, height:{ideal:1080}, aspectRatio:{ideal:16/9} }
    };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    videoEl.srcObject = stream;
    await videoEl.play();
    return stream;
  }
  function prepSquareFrame(videoEl, canvasEl){
    const vw=videoEl.videoWidth||1280, vh=videoEl.videoHeight||720;
    const s=Math.min(vw,vh), sx=(vw-s)/2, sy=(vh-s)/2;
    const size=800; canvasEl.width=size; canvasEl.height=size;
    return { sx,sy,s,dx:0,dy:0,w:size,h:size };
  }
  function startScanner({boxId,videoId,canvasId,statusId,onDecoded}){
    const box=$(boxId), video=$(videoId), canvas=$(canvasId), status=$(statusId);
    let stream=null, raf=null, running=false;
    async function begin(){
      box.style.display="";
      status.textContent="启动摄像头…";
      try{
        stream=await openCamera(video);
        status.textContent="请将二维码置于白框内";
        running=true; tick();
        window.addEventListener("resize", onResize); window.addEventListener("orientationchange", onResize);
      }catch(e){ status.textContent="摄像头失败："+e.message; }
    }
    function stop(){
      running=false;
      if(raf) cancelAnimationFrame(raf), raf=null;
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
      video.srcObject=null; box.style.display="none";
      window.removeEventListener("resize", onResize); window.removeEventListener("orientationchange", onResize);
    }
    function onResize(){}
    function tick(){
      if(!running){ return; }
      if(!video.videoWidth){ raf=requestAnimationFrame(tick); return; }
      const ctx=canvas.getContext("2d");
      const {sx,sy,s,dx,dy,w,h}=prepSquareFrame(video,canvas);
      ctx.drawImage(video, sx,sy,s,s, dx,dy,w,h);
      const img=ctx.getImageData(0,0,w,h);
      const code=jsQR(img.data,w,h,{inversionAttempts:"attemptBoth"});
      if(code && code.data){
        const ok = onDecoded(code.data);
        if(ok){ stop(); return; }
      }
      raf=requestAnimationFrame(tick);
    }
    return { begin, stop };
  }

  // ========= 1) 接收 tx_human.json（支持多帧 SAFEQR）或 原生 EIP-1559 =========
  let session = null; // { id, n, sum, parts:[], received:Set, text? }
  function resetSession(){ session=null; $("rx_status").textContent="已重置"; $("tx_human_view").textContent=""; $("txt_txjson").value=""; }
  $("btn_reset_session").onclick = resetSession;

  function tryFeedFrame(text){
    // 1) SAFEQR 容器
    try{
      const o=JSON.parse(text);
      if(o && o.t==="SAFEQR" && o.v===1 && typeof o.id==="string" && typeof o.i==="number" && typeof o.n==="number" && typeof o.data==="string"){
        if(!session || session.id!==o.id){
          session = { id:o.id, n:o.n, sum:o.sum||"", parts:new Array(o.n), received:new Set() };
        }
        if(o.n!==session.n) return false;
        session.parts[o.i]=o.data; session.received.add(o.i);
        const got=[...session.received].sort((a,b)=>a-b).join(",");
        $("rx_status").textContent = `会话 ${session.id}：已收帧 ${session.received.size}/${session.n}（索引：${got}）`;
        if(session.received.size===session.n){
          session.text = session.parts.join("");
          return true;
        }
        return false;
      }
    }catch(_){}
    // 2) 单帧 JSON
    try{
      JSON.parse(text);
      session = { id:"single", n:1, sum:"", parts:[text], received:new Set([0]), text };
      $("rx_status").textContent = `单帧 JSON 已接收（长度 ${text.length}）`;
      return true;
    }catch(_){}
    return false;
  }

  const txScanner = startScanner({
    boxId:"cam_tx", videoId:"video_tx", canvasId:"canvas_tx", statusId:"scan_tx_status",
    onDecoded:(payload)=> tryFeedFrame((payload||"").trim())
  });
  $("btn_scan_tx").onclick = ()=> txScanner.begin();
  $("btn_stop_tx").onclick = ()=> txScanner.stop();

  // 紧凑键名 <-> 标准键名 的映射（tx_human）
  const K2S = {k:"kind",f:"from",t:"to",vw:"value_wei",ae:"amount_eth",d:"data_hex",c:"chainId",n:"nonce",g:"gas",mf:"maxFeePerGas_gwei",mp:"maxPriorityFeePerGas_gwei"};
  function expandCompact(obj){ const out={}; for(const k in obj){ out[K2S[k]||k]=obj[k]; } return out; }

  // 工具：把任意（十进制字符串/数字/十六进制字符串）解析为 BigInt
  function toBigIntLoose(v){
    if(typeof v==="bigint") return v;
    if(typeof v==="number") return BigInt(Math.trunc(v));
    if(typeof v==="string"){
      const s=v.trim();
      if(/^0x[0-9a-fA-F]+$/.test(s)) return BigInt(s);
      if(/^\d+(\.\d+)?$/.test(s)){
        if(s.includes(".")) throw new Error("不支持小数（请使用整数的最小单位或合适字段）");
        return BigInt(s);
      }
    }
    throw new Error("无法解析数值："+v);
  }
  function toNumberLoose(v){
    if(typeof v==="number") return v;
    if(typeof v==="string" && /^\d+(\.\d+)?$/.test(v)) return Number(v);
    if(typeof v==="string" && /^0x[0-9a-fA-F]+$/.test(v)) return parseInt(v,16);
    if(typeof v==="bigint") return Number(v);
    throw new Error("无法解析为数字："+v);
  }
  function gweiFromWeiLike(v){ // 输入可能是 wei(hex/dec/num/bigint) 或 gwei(字符串带小数)
    if(typeof v==="string" && !/^0x/i.test(v) && v.includes(".")){
      // 视为 gwei（例如 "12.5"）
      return v;
    }
    const wei = toBigIntLoose(v);
    const gweiStr = ethers.formatUnits(wei, "gwei");
    // 保留合适小数位（最多 6 位）
    const [i,f=""] = gweiStr.split(".");
    return f ? (i+"."+f.slice(0,6).replace(/0+$/,"")).replace(/\.$/,"") : i;
  }

  function isLikelyRaw1559(o){
    if(o==null || typeof o!=="object") return false;
    if(o.type===2 || o.type==="0x2") return true;
    if(o.maxFeePerGas!=null || o.maxPriorityFeePerGas!=null) return true;
    if(o.gas!=null || o.gasLimit!=null) return true;
    return false;
  }

  function normalizeFromTxHumanText(text){
    const raw=JSON.parse(text);
    const obj=expandCompact(raw);
    // 允许 value_wei 或 amount_eth，data_hex 可缺省
    const chainId = toNumberLoose(obj.chainId);
    const to = String(obj.to||"").trim();
    const data = (obj.data_hex||"0x").trim();
    const nonce = (obj.nonce!=null) ? toNumberLoose(obj.nonce) : "";
    const gas = (obj.gas!=null) ? toNumberLoose(obj.gas) : "";
    // 金额
    let valueWei="0";
    if(obj.value_wei!=null) valueWei = String(toBigIntLoose(obj.value_wei));
    else if(obj.amount_eth!=null) valueWei = ethers.parseUnits(String(obj.amount_eth), "ether").toString();
    // 价格（gwei）
    const maxFeeGwei = (obj.maxFeePerGas_gwei!=null) ? String(obj.maxFeePerGas_gwei) : "";
    const maxPrioGwei = (obj.maxPriorityFeePerGas_gwei!=null) ? String(obj.maxPriorityFeePerGas_gwei) : "";
    return { schema:"tx_human", chainId, to, data, nonce, gas, valueWei, maxFeeGwei, maxPrioGwei, pretty:obj };
  }

  function normalizeFromRaw1559(o){
    // 解析常见字段：hex/dec 都可
    const chainId = toNumberLoose(o.chainId);
    const nonce   = toNumberLoose(o.nonce);
    const to      = String(o.to||"").trim();
    const data    = (o.data||"0x").trim();
    const gas     = (o.gas!=null)? toNumberLoose(o.gas) : (o.gasLimit!=null? toNumberLoose(o.gasLimit) : "");
    // 金额（wei）
    const valueWei = String( toBigIntLoose(o.value||0) );
    // 价格：原生一般是 wei（hex/dec），统一换算到 gwei 文本
    const maxFeeGwei = (o.maxFeePerGas!=null) ? gweiFromWeiLike(o.maxFeePerGas) : "";
    const maxPrioGwei= (o.maxPriorityFeePerGas!=null) ? gweiFromWeiLike(o.maxPriorityFeePerGas) : "";
    return { schema:"raw_1559", chainId, to, data, nonce, gas, valueWei, maxFeeGwei, maxPrioGwei, pretty:o };
  }

  async function sha256Hex(str){
    const bytes=new TextEncoder().encode(str);
    const hash=await crypto.subtle.digest("SHA-256", bytes);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  function detectAndNormalize(text){
    const parsed=JSON.parse(text);
    if(isLikelyRaw1559(parsed)) return normalizeFromRaw1559(parsed);
    return normalizeFromTxHumanText(text);
  }

  $("btn_parse_tx").onclick = async ()=>{
    try{
      let txt = $("txt_txjson").value.trim();
      if(!txt){
        if(!session || !session.text) throw new Error("请先扫码或粘贴 JSON");
        txt = session.text;
      }
      // SAFEQR 的完整性校验（如有）
      if(session && session.sum){
        const fullHash = await sha256Hex(txt);
        const short = fullHash.slice(0,16);
        if(short.toLowerCase() !== session.sum.toLowerCase()){
          throw new Error(`整体哈希不匹配：expected ${session.sum} got ${short}`);
        }
      }
      const norm = detectAndNormalize(txt);
      // 回填表单
      $("chainId").value = norm.chainId ?? "";
      $("to").value      = norm.to ?? "";
      $("dataHex").value = norm.data ?? "0x";
      $("nonce").value   = norm.nonce ?? "";
      $("gas").value     = norm.gas ?? "";
      $("valueWei").value= norm.valueWei ?? "0";
      if(norm.maxFeeGwei!=="")  $("maxFee").value = norm.maxFeeGwei;
      if(norm.maxPrioGwei!=="") $("maxPrio").value= norm.maxPrioGwei;

      $("tx_human_view").textContent = JSON.stringify({schema:norm.schema, normalized:{
        chainId:norm.chainId, nonce:norm.nonce, to:norm.to, valueWei:norm.valueWei,
        gasLimit:norm.gas, maxFeePerGas_gwei:norm.maxFeeGwei, maxPriorityFeePerGas_gwei:norm.maxPrioGwei,
        data:norm.data
      }, original:norm.pretty}, null, 2);
      $("parse_tx_status").textContent = `解析成功（${norm.schema}）`;
    }catch(e){
      $("parse_tx_status").textContent = "错误："+e.message;
      $("tx_human_view").textContent="";
    }
  };

  $("btn_lock").onclick = ()=> $("btn_parse_tx").click();

  // ========= 2) 私钥扫码/清空 =========
  function extractPriv(text){
    const s=text.trim();
    if(/^0x[0-9a-fA-F]{64}$/.test(s)) return s;
    try{
      const j=JSON.parse(s);
      if(j && typeof j==="object"){
        if(typeof j.privateKey==="string" && /^0x[0-9a-fA-F]{64}$/.test(j.privateKey)) return j.privateKey;
        if(typeof j.priv==="string" && /^0x[0-9a-fA-F]{64}$/.test(j.priv)) return j.priv;
      }
    }catch(_){}
    return null;
  }
  const privScanner = startScanner({
    boxId:"cam_priv", videoId:"video_priv", canvasId:"canvas_priv", statusId:"scan_priv_status",
    onDecoded:(payload)=>{
      const maybe = extractPriv((payload||"").trim());
      if(maybe){ $("priv").value=maybe; $("priv_status").textContent="已通过二维码填入私钥"; return true; }
      return false;
    }
  });
  $("btn_scan_priv").onclick = ()=> privScanner.begin();
  $("btn_stop_priv").onclick = ()=> privScanner.stop();
  $("btn_clear_priv").onclick = ()=> { $("priv").value=""; $("priv_status").textContent="已清空"; };

  // ========= 3) 签名（EIP-1559） =========
  function toWeiGwei(x){ return ethers.parseUnits(String(x), "gwei"); }
  $("btn_sign").onclick = async ()=>{
    try{
      const priv=($("priv").value||"").trim();
      if(!/^0x[0-9a-fA-F]{64}$/.test(priv)) throw new Error("私钥格式不正确");
      const w=new ethers.Wallet(priv);

      const chainId=Number($("chainId").value||"");
      const nonce=Number($("nonce").value||"");
      const to=($("to").value||"").trim();
      const valueWei=BigInt(($("valueWei").value||"0").trim());
      const gasLimit=BigInt(($("gas").value||"").trim());
      const maxFeePerGas=toWeiGwei(($("maxFee").value||"").trim());
      const maxPriorityFeePerGas=toWeiGwei(($("maxPrio").value||"").trim());
      const data=($("dataHex").value||"0x").trim();

      if(!chainId) throw new Error("缺少 chainId");
      if(!Number.isFinite(nonce)) throw new Error("缺少或不合法的 nonce");
      if(!/^0x[0-9a-fA-F]{40}$/.test(to)) throw new Error("to 地址不合法");
      if(!data.startsWith("0x")) throw new Error("data 必须以 0x 开头");
      if(gasLimit<=0n) throw new Error("gasLimit 不能为空");
      if(maxFeePerGas<=0n || maxPriorityFeePerGas<0n) throw new Error("gas 价格不合法");
      if(maxFeePerGas<maxPriorityFeePerGas) throw new Error("maxFeePerGas 必须 ≥ maxPriorityFeePerGas");

      const tx = {
        type: 2, chainId, nonce,
        to, value: valueWei, data,
        gasLimit,
        maxFeePerGas, maxPriorityFeePerGas
      };
      const raw = await w.signTransaction(tx);
      const txhash = ethers.keccak256(raw);
      $("rawtx").value = raw;
      $("txhash").value = txhash;
      $("sign_status").textContent = "签名完成";

      const div=$("qr_raw"); div.innerHTML="";
      new QRCode(div,{text:raw,width:280,height:280,colorDark:"#000",colorLight:"#fff",correctLevel:QRCode.CorrectLevel.M});
    }catch(e){
      $("sign_status").textContent="错误："+e.message;
      $("rawtx").value=""; $("txhash").value=""; $("qr_raw").innerHTML="";
    }
  };
})();
</script>
</body>
</html>
